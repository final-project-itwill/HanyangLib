<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="community">



    <!-- 페이징 없는 list : book 테이블 조인해서 목록 출력  -->
    <select id="list1" resultType="kr.co.itwill.community.BookReadDTO">
        SELECT c_code, c_name, c_des, c_bcode, c_local, c_id, c_chat, c_banner ,c_count, c_state, c_rdate, b_name, b_bookcover
        FROM book JOIN community
        ON book.b_code = community.c_bcode
        ORDER BY c_code DESC
    </select>

    <!-- 페이징 있는 목록 -->
    <select id="list" resultType="kr.co.itwill.community.BookReadDTO">
        select AA.*
        FROM(
                select @RNO := @RNO + 1 as r, CC.*
                FROM(
                    SELECT c_code, c_name, c_des, c_bcode, c_local, c_id, c_chat, c_banner ,c_count, c_state, c_rdate, b_name, b_bookcover
                    FROM book JOIN community
                    ON book.b_code = community.c_bcode
                    ORDER BY c_code DESC
                    ) CC, (SELECT @RNO := 0) BB ORDER BY c_rdate DESC
            ) AA
        WHERE r BETWEEN #{startRow} AND #{endRow}
        ORDER BY c_rdate DESC
    </select>

    <!-- 총 행 갯수 -->
    <select id="totalRowCount" resultType="int">
        SELECT COUNT(*)
        FROM community
    </select>

    <!-- 검색 -->
    <select id="search" resultType="kr.co.itwill.community.BookReadDTO" parameterType="String">
        SELECT c_code, c_name, c_des, c_bcode, c_local, c_id, c_chat, c_banner ,c_count, c_state, c_rdate, b_name, b_bookcover
        FROM book JOIN community
        ON book.b_code = community.c_bcode
        WHERE c_name LIKE CONCAT('%', #{keyword}, '%') || b_name LIKE CONCAT('%', #{keyword}, '%')
    </select>


    <!-- list 최신순 정렬 -->
    <select id="newComm" resultType="kr.co.itwill.community.BookReadDTO">
        SELECT c_code, c_name, c_des, c_bcode, c_local, c_id, c_chat, c_banner ,c_count, c_state, c_rdate, b_name, b_bookcover
        FROM book JOIN community
        ON book.b_code = community.c_bcode
        ORDER BY c_rdate DESC LIMIT 3
    </select>


    <!-- read 상세보기  -->
    <select id="read" resultType="kr.co.itwill.community.BookReadDTO">
        SELECT c_code, c_name, c_des, c_bcode, c_local, c_id, c_chat, c_banner ,c_count, c_state, c_rdate, b_name, b_bookcover, m_nick
        FROM book JOIN community
        ON book.b_code = community.c_bcode
        JOIN member ON community.c_id = member.m_id
        WHERE c_code = #{c_code}
    </select>



    <!--  나만의 서재 조회  -->
    <select id="listMylib" resultType="kr.co.itwill.community.CommunityMylipDTO">
        SELECT lib_id, b_code, b_name, b_bookcover, lib_proc
        FROM mylib
                 JOIN book
                      ON mylib.lib_bcode = book.b_code
        WHERE lib_id = #{loginID} and lib_proc >= 0;
    </select>

    <select id="readBook" resultType="kr.co.itwill.book.BookDTO">
        SELECT b_code, b_name
        FROM book
        WHERE b_code = #{b_code}
    </select>

    <insert id="insert" parameterType="kr.co.itwill.community.CommunityDTO">
        INSERT INTO community (c_code, c_name, c_des, c_bcode, c_local, c_id, c_chat, c_banner ,c_count)
        VALUES (#{c_code}, #{c_name}, #{c_des}, #{c_bcode}, #{c_local}, #{c_id}, #{c_chat}, #{c_banner}, #{c_count})
    </insert>


    <select id="filename" resultType="String">
        SELECT c_banner
        FROM community
        WHERE c_code = #{c_code}
    </select>

    <delete id="delete">
        DELETE FROM community
        WHERE c_code = #{c_code}
    </delete>

    <update id="update">
        UPDATE community
        SET c_name    = #{c_name}
            ,c_des    = #{c_des}
            ,c_local  = #{c_local}
            ,c_chat   = #{c_chat}
            ,c_banner = #{c_banner}
            ,c_count  = #{c_count}
        WHERE c_code  = #{c_code}
    </update>


    <!--  PK키 코드 쿼리  -->
    <select id="createCode" resultType="int">
        SELECT MAX(CAST(substr(c_code, 4, 6) AS INT))
        FROM community
    </select>


    <!-- 가입 신청 조건 쿼리 -->
    <select id="checkID" resultType="kr.co.itwill.community.CommSignDTO">
        SELECT s_id, s_state
        FROM community_signup
        WHERE s_code = #{s_code} AND s_id = #{s_id}
    </select>


    <!-- 커뮤니티장 조회 -->
    <select id="checkOwner" resultType="String">
        SELECT c_id
        FROM community
        WHERE c_code = #{c_code}
    </select>


    <!-- 커뮤니티 구성원 조회-->
    <select id="checkMember" resultType="kr.co.itwill.community.CommSignDTO">
        SELECT s_no, s_code , s_id, s_nick, s_state, s_surveycode, s_rdate
        FROM community_signup
        WHERE s_code = #{c_code}
    </select>

    <!-- 해당 커뮤니티 가입한 사람 수 -->
    <select id="memberCnt" resultType="int">
        SELECT COUNT(*)
        FROM community_signup
        WHERE s_code = #{c_code}
    </select>


    <!-- 해당 커뮤니티 총 후기 갯수-->
    <select id="reviewCnt" resultType="int" parameterType="String">
        <![CDATA[
        SELECT COUNT(*)
        FROM community_ac
        WHERE ac_ccode = #{c_code}
        ]]>
    </select>


</mapper>